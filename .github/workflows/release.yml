name: Cross-platform JAR Release with Launchers

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'

jobs:
  build-all:
    permissions:
      contents: write

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Set Maven version from tag
        run: mvn versions:set -DnewVersion=${GITHUB_REF#refs/tags/}

      - name: Build JAR
        run: mvn -B package --file pom.xml

      - name: Create Linux package with shell launcher
        run: |
          mkdir dist-linux
          cp target/*.jar dist-linux/costsplit.jar
          cat > dist-linux/run.sh <<'EOF'
          #!/bin/sh
          export COSTSPLIT_URI=https://costsplit-456211.oa.r.appspot.com
          /usr/bin/exec /usr/bin/java -jar "costsplit.jar" "$@"
          EOF
          chmod +x dist-linux/run.sh
          tar -czf costsplit-linux.tar.gz -C dist-linux .

      - name: Upload Linux package to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: costsplit-linux.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Windows package with .bat launcher
        run: |
          mkdir dist-windows
          cp target/*.jar dist-windows/costsplit.jar
          cat > dist-windows/run.bat <<'EOF'
          @echo off
          set COSTSPLIT_URI=https://costsplit-456211.oa.r.appspot.com
          start javaw -jar "costsplit.jar" %%*
          EOF
          zip -r costsplit-windows.zip dist-windows

      - name: Upload Windows package to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: costsplit-windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
